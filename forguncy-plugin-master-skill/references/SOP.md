# 活字格 (Forguncy) 插件开发标准作业程序 (SOP)

本 SOP 旨在为开发者提供一套标准化的活字格插件开发流程，确保插件的质量、稳定性和可维护性。

## 阶段一：环境准备与项目初始化

**目标**：建立可运行的开发环境和基础项目结构。

1.  **环境检查**：
    *   确保已安装 .NET SDK (建议 .NET 6.0 或更高)。
    *   确保已安装活字格设计器 (用于调试和打包)。
    *   确保已安装 "活字格插件构建器" (推荐) 或具备手动配置 `.csproj` 的能力。

2.  **项目初始化**：
    *   **推荐方式**：使用 `InitProject.ps1` 脚本调用官方构建器。
    *   **操作**：运行初始化脚本 -> 在构建器 GUI 中填写插件信息 (ID, 名称, 版本) -> 生成项目文件。
    *   **产出**：包含 `.csproj` 和基础 `.cs` 文件的项目目录。

## 阶段二：需求分析与计划 (覆盖所有任务)

**目标**：在编码前明确设计方案，确保引用正确，无论是新开发还是整改。

1.  **编写计划文档**：
    *   **位置与命名**：
        *   在项目根目录创建 `plans/` 文件夹（如不存在）。
        *   使用有意义的文件名，推荐格式：`plans/序号_需求描述.md` (如 `plans/001_InitProject.md`)。
    *   **内容结构**：
        *   **需求分析**：明确插件要解决的问题或整改目标。
        *   **模板/文件选择**：指定使用的代码模板或要修改的源文件。
        *   **文档引用 (关键)**：列出参考的规范文档。**必须使用相对路径链接**，例如 `[异常处理](../docs/references/ServerCommand/Process_Exception_Handling.md)` (注意从 plans 目录出发的相对路径)。
        *   **详细设计**：规划属性、方法及逻辑变更点。

2.  **用户确认与锁定**：
    *   提交计划文档给用户审核。
    *   **锁定上下文**：一旦用户确认，后续开发**必须**严格基于此文档执行，不得随意偏离。

## 阶段三：插件定义与属性设计 (实施)

**目标**：将设计转化为代码中的属性定义。

1.  **确定插件类型**：
    *   **服务端命令 (ServerCommand)**：用于后端逻辑、数据库交互。
    *   **单元格类型 (CellType)**：用于自定义前端 UI、图表。
        *   **注意**：明确区分 **设计器端** (C# 代码，负责属性配置与WPF预览) 与 **Web端/查看端** (JS 代码，负责浏览器渲染) 的需求。
    *   **客户端命令 (ClientCommand)**：用于前端页面跳转、交互。
    *   **服务端 API (ServerAPI)**：用于对外提供 HTTP 接口。

2.  **属性定义**：
    *   在主类中添加公共属性。
    *   使用 `[DisplayName("中文显示名")]` 标记属性。
    *   根据需要添加 `[FormulaProperty]` (支持公式)、`[ComboProperty]` (下拉框) 等特性。
    *   **参考文档**：`docs/references/<Type>/Add_Property_*.md`

3.  **设计器行为 (可选)**：
    *   实现 `GetDesignerPropertyEditorSettings` 以自定义编辑器。
    *   实现 `Validate` 方法以在设计时检查配置错误。

## 阶段四：核心逻辑实现

**目标**：实现插件的运行时功能。

1.  **服务端逻辑 (ServerCommand/ServerAPI)**：
    *   重写 `Execute` 方法。
    *   **数据库操作**：使用 `this.Context.DataAccess` (严禁 `new SqlConnection`)。
    *   **参数获取**：解析传入的属性值 (处理公式计算结果)。
    *   **异常处理**：使用 `try-catch` 捕获异常，并返回明确的错误信息。
    *   **日志记录**：使用 `this.Context.Logger` (严禁 `Console.WriteLine`)。

2.  **前端逻辑 (CellType/ClientCommand)**：
    *   编写 JavaScript 代码实现 UI 渲染或交互。
    *   **资源引用**：使用 `GetTemplateGlobalJavaScript` 引入第三方库。
    *   **数据交互**：使用 `Forguncy.Page` API 获取/设置单元格值。

## 阶段五：构建与测试

**目标**：生成插件包并验证功能。

1.  **构建**：
    *   使用 Visual Studio 或 `dotnet build` 编译项目。
    *   使用活字格构建器打包生成 `.zip` 插件包。

2.  **安装测试**：
    *   在活字格设计器中安装生成的插件。
    *   创建一个测试页面，拖入插件或调用命令。
    *   运行应用，验证功能是否符合预期。
    *   检查控制台 (前端 F12) 或服务器日志是否有错误。

## 阶段六：发布与维护

**目标**：交付最终产物并进行后续维护。

1.  **文档编写**：
    *   编写插件使用说明书，解释各属性的作用和使用示例。
2.  **版本管理**：
    *   每次更新前修改 `AssemblyInfo.cs` 或构建器中的版本号。
